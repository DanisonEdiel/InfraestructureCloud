import psycopg2
from psycopg2.extras import RealDictCursor

# ============================================
# CONFIGURACI√ìN DIRECTA (pon tu cadena de Neon)
# ============================================

DATABASE_URL = ""

import psycopg2
from psycopg2.extras import RealDictCursor

# ============================================
# CONFIGURACI√ìN DIRECTA (pon tu cadena de Neon)
# ============================================

DATABASE_URL = "postgresql://neondb_owner:npg_IxGQ1nUAiBY8@ep-raspy-cake-ad01wc64-pooler.c-2.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"

# ============================================
#   CONEXI√ìN A LA BD (manejo limpio)
# ============================================
try:
    conn = psycopg2.connect(DATABASE_URL, cursor_factory=RealDictCursor)
    print("‚úÖ Conexi√≥n exitosa a Neon\n")

except psycopg2.OperationalError as e:
    print("‚ùå Error de conexi√≥n a Neon:")
    print(e)
    exit()
except Exception as e:
    print("‚ùå Error inesperado al conectar:")
    print(e)
    exit()

# ============================================
#   INSERTAR UN REGISTRO
# ============================================
try:
    with conn.cursor() as cursor:
        cursor.execute("""
            INSERT INTO visits (name, comment, image_url, public_id)
            VALUES (%s, %s, %s, %s)
            RETURNING *;
        """, (
            "Willian",
            "Prueba monol√≠tica desde Python (versi√≥n mejorada)",
            "https://fake.com/test.jpg",
            "visits/test_monolitico"
        ))

        nuevo = cursor.fetchone()
        conn.commit()

        print("‚ú® Registro insertado correctamente:")
        print(nuevo)

except psycopg2.DataError as e:
    print("‚ùå Error en los datos enviados:")
    print(e)

except Exception as e:
    print("‚ùå Error inesperado en INSERT:")
    print(e)

# ============================================
#   SELECT * DESDE LA TABLA
# ============================================
try:
    print("\nüìå CONTENIDO COMPLETO DE LA TABLA 'visits':\n")

    with conn.cursor() as cursor:
        cursor.execute("SELECT * FROM visits ORDER BY created_at DESC;")
        registros = cursor.fetchall()

        for r in registros:
            print(r)

except psycopg2.ProgrammingError as e:
    print("‚ùå Error al ejecutar SELECT (¬øtabla incorrecta?):")
    print(e)

except Exception as e:
    print("‚ùå Error inesperado en SELECT:")
    print(e)

# ============================================
#   CERRAR CONEXI√ìN
# ============================================
finally:
    conn.close()
    print("\nüîö Conexi√≥n cerrada correctamente.")
